import ollama
import re
import json
from typing import Dict, List, Optional
import random


class PotolkiBot:
    """–†—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã–π –±–æ—Ç –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ –ø—Ä–æ–¥–∞–∂–µ –Ω–∞—Ç—è–∂–Ω—ã—Ö –ø–æ—Ç–æ–ª–∫–æ–≤"""

    def __init__(self, model_name: str = "llama3.2:3b"):
        self.model_name = model_name
        self.company_info = self._get_company_info()
        self.templates = self._get_templates()
        self.conversation_history = []

    def _get_company_info(self) -> Dict:
        """–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–ø–∞–Ω–∏–∏"""
        return {
            "name": "–ü—Ä–æ—Ñ–∏–ü–æ—Ç–æ–ª–∫–∏",
            "description": "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—Ç—è–∂–Ω—ã—Ö –ø–æ—Ç–æ–ª–∫–æ–≤",
            "services": [
                "–ù–∞—Ç—è–∂–Ω—ã–µ –ø–æ—Ç–æ–ª–∫–∏ –ª—é–±–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏",
                "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞ 1 –¥–µ–Ω—å",
                "–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∑–∞–º–µ—Ä –∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è",
                "–ì–∞—Ä–∞–Ω—Ç–∏—è 5 –ª–µ—Ç",
                "–ú–æ–Ω—Ç–∞–∂ —Å–≤–µ—Ç–∏–ª—å–Ω–∏–∫–æ–≤ –∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∏"
            ],
            "materials": [
                "–ú–∞—Ç–æ–≤—ã–µ –ø–æ—Ç–æ–ª–∫–∏",
                "–ì–ª—è–Ω—Ü–µ–≤—ã–µ –ø–æ—Ç–æ–ª–∫–∏",
                "–°–∞—Ç–∏–Ω–æ–≤—ã–µ –ø–æ—Ç–æ–ª–∫–∏",
                "–ü–æ—Ç–æ–ª–∫–∏ —Å —Ñ–æ—Ç–æ–ø–µ—á–∞—Ç—å—é",
                "–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ –ø–æ—Ç–æ–ª–∫–∏"
            ],
            "prices": {
                "–º–∞—Ç–æ–≤—ã–π": "–æ—Ç 450 —Ä—É–±/–º¬≤",
                "–≥–ª—è–Ω—Ü–µ–≤—ã–π": "–æ—Ç 550 —Ä—É–±/–º¬≤",
                "—Å–∞—Ç–∏–Ω–æ–≤—ã–π": "–æ—Ç 500 —Ä—É–±/–º¬≤",
                "–º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π": "–æ—Ç 800 —Ä—É–±/–º¬≤",
                "—Å_—Ñ–æ—Ç–æ–ø–µ—á–∞—Ç—å—é": "–æ—Ç 1200 —Ä—É–±/–º¬≤"
            },
            "contact": {
                "phone": "+7 (XXX) XXX-XX-XX",
                "email": "info@profigpotolki.ru",
                "hours": "–ü–Ω-–ü—Ç: 9:00-20:00, –°–±-–í—Å: 10:00-18:00"
            }
        }

    def _get_templates(self) -> Dict[str, List[str]]:
        """–®–∞–±–ª–æ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ —á–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã"""
        return {
            "–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ": [
                "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –ø–æ–º–æ—â–Ω–∏–∫ –∫–æ–º–ø–∞–Ω–∏–∏ {name}. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?",
                "–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –ö–æ–º–ø–∞–Ω–∏—è {name} –≥–æ—Ç–æ–≤–∞ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã.",
                "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é! {description}. –ö–∞–∫–æ–π –≤–æ–ø—Ä–æ—Å –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?"
            ],
            "—Ü–µ–Ω–∞": [
                "–°—Ç–æ–∏–º–æ—Å—Ç—å –Ω–∞—Ç—è–∂–Ω—ã—Ö –ø–æ—Ç–æ–ª–∫–æ–≤ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–∞: {price_list}",
                "–¶–µ–Ω—ã –Ω–∞ –Ω–∞—Ç—è–∂–Ω—ã–µ –ø–æ—Ç–æ–ª–∫–∏: {price_list}. –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∑–∞–º–µ—Ä –ø–æ–º–æ–∂–µ—Ç —Ç–æ—á–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å.",
                "–£ –Ω–∞—Å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ü–µ–Ω—ã: {price_list}. –†–∞—Å—Å—á–∏—Ç–∞–µ–º —Ç–æ—á–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ—Å–ª–µ –∑–∞–º–µ—Ä–∞."
            ],
            "–º–∞—Ç–µ—Ä–∏–∞–ª—ã": [
                "–ú—ã —Ä–∞–±–æ—Ç–∞–µ–º —Å —Ä–∞–∑–Ω—ã–º–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏: {materials}",
                "–ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø–æ—Ç–æ–ª–∫–∏ –∏–∑ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤: {materials}",
                "–í—ã –º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å: {materials}. –ü–æ–º–æ–≥—É –ø–æ–¥–æ–±—Ä–∞—Ç—å –ª—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç."
            ],
            "—É—Å—Ç–∞–Ω–æ–≤–∫–∞": [
                "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç 1 —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å. –†–∞–±–æ—Ç–∞–µ–º —á–∏—Å—Ç–æ –∏ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ.",
                "–ú–æ–Ω—Ç–∞–∂ –Ω–∞—Ç—è–∂–Ω–æ–≥–æ –ø–æ—Ç–æ–ª–∫–∞ –ø—Ä–æ–≤–æ–¥–∏—Ç—Å—è –∑–∞ 1 –¥–µ–Ω—å —Å –≥–∞—Ä–∞–Ω—Ç–∏–µ–π –∫–∞—á–µ—Å—Ç–≤–∞.",
                "–ù–∞—à–∏ –º–∞—Å—Ç–µ—Ä–∞ —É—Å—Ç–∞–Ω–æ–≤—è—Ç –ø–æ—Ç–æ–ª–æ–∫ –∑–∞ 1 –¥–µ–Ω—å —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –±–µ—Å–ø–æ—Ä—è–¥–∫–æ–º."
            ],
            "–∑–∞–º–µ—Ä": [
                "–ó–∞–º–µ—Ä –∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ! –ú–∞—Å—Ç–µ—Ä –ø—Ä–∏–µ–¥–µ—Ç –≤ —É–¥–æ–±–Ω–æ–µ –¥–ª—è –≤–∞—Å –≤—Ä–µ–º—è.",
                "–ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∑–∞–º–µ—Ä –∏ —Ä–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏. –ü–æ–¥–±–µ—Ä–µ–º –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ.",
                "–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –≤—ã–µ–∑–¥ –∑–∞–º–µ—Ä—â–∏–∫–∞ –∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –ø–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º."
            ],
            "–≥–∞—Ä–∞–Ω—Ç–∏—è": [
                "–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º –≥–∞—Ä–∞–Ω—Ç–∏—é 5 –ª–µ—Ç –Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ –º–æ–Ω—Ç–∞–∂.",
                "–ì–∞—Ä–∞–Ω—Ç–∏—è –Ω–∞ –Ω–∞—à–∏ –ø–æ—Ç–æ–ª–∫–∏ - 5 –ª–µ—Ç. –í—Å–µ–≥–¥–∞ –Ω–∞ —Å–≤—è–∑–∏ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤.",
                "5 –ª–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏–∏ –Ω–∞ –≤—Å–µ –≤–∏–¥—ã —Ä–∞–±–æ—Ç –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã."
            ],
            "–∫–æ–Ω—Ç–∞–∫—Ç—ã": [
                "–ù–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã: —Ç–µ–ª–µ—Ñ–æ–Ω {phone}, email {email}. –†–∞–±–æ—Ç–∞–µ–º {hours}.",
                "–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏: {phone} –∏–ª–∏ {email}. –ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã: {hours}.",
                "–ó–≤–æ–Ω–∏—Ç–µ: {phone}. –ü–∏—à–∏—Ç–µ: {email}. –†–∞–±–æ—Ç–∞–µ–º: {hours}."
            ],
            "–Ω–µ_–∑–Ω–∞—é": [
                "–£—Ç–æ—á–Ω—é —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å —É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –∏ –æ—Ç–≤–µ—á—É –≤–∞–º –ø–æ–∑–∂–µ.",
                "–î–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É—é—Å—å —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º.",
                "–≠—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç —É—Ç–æ—á–Ω–µ–Ω–∏—è. –°–≤—è–∂—É—Å—å —Å –≤–∞–º–∏ –ø–æ–∑–∂–µ."
            ]
        }

    def _format_template(self, template: str) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —à–∞–±–ª–æ–Ω —Å –¥–∞–Ω–Ω—ã–º–∏ –∫–æ–º–ø–∞–Ω–∏–∏"""
        return template.format(
            name=self.company_info["name"],
            description=self.company_info["description"],
            price_list=", ".join([f"{k}: {v}" for k, v in self.company_info["prices"].items()]),
            materials=", ".join(self.company_info["materials"]),
            phone=self.company_info["contact"]["phone"],
            email=self.company_info["contact"]["email"],
            hours=self.company_info["contact"]["hours"]
        )

    def _find_template_response(self, question: str) -> Optional[str]:
        """–ò—â–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏–π —à–∞–±–ª–æ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç"""
        question_lower = question.lower()

        # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        keyword_map = {
            "–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ": ["–ø—Ä–∏–≤–µ—Ç", "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ", "–¥–æ–±—Ä—ã–π", "hello", "hi", "–∑–¥—Ä–∞—Å—Ç–≤—É–π—Ç–µ"],
            "—Ü–µ–Ω–∞": ["—Ü–µ–Ω–∞", "—Å—Ç–æ–∏–º–æ—Å—Ç—å", "—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç", "–ø—Ä–∞–π—Å", "—Ü–µ–Ω", "–¥–µ–Ω—å–≥–∏", "—Ä—É–±"],
            "–º–∞—Ç–µ—Ä–∏–∞–ª—ã": ["–º–∞—Ç–µ—Ä–∏–∞–ª", "—Ç–∫–∞–Ω—å", "–ø–ª–µ–Ω–∫–∞", "–≥–ª—è–Ω–µ—Ü", "–º–∞—Ç", "—Å–∞—Ç–∏–Ω", "—Ñ–æ—Ç–æ–ø–µ—á–∞—Ç—å"],
            "—É—Å—Ç–∞–Ω–æ–≤–∫–∞": ["—É—Å—Ç–∞–Ω–æ–≤–∫–∞", "–º–æ–Ω—Ç–∞–∂", "—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å", "—Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å", "—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç–µ"],
            "–∑–∞–º–µ—Ä": ["–∑–∞–º–µ—Ä", "–ø—Ä–∏–µ—Ö–∞—Ç—å", "–ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å", "–æ—Ü–µ–Ω–∏—Ç—å", "–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è"],
            "–≥–∞—Ä–∞–Ω—Ç–∏—è": ["–≥–∞—Ä–∞–Ω—Ç–∏—è", "–≥–∞—Ä–∞–Ω—Ç–∏–π", "—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞", "–≤–æ–∑–≤—Ä–∞—Ç", "–æ–±–º–µ–Ω"],
            "–∫–æ–Ω—Ç–∞–∫—Ç—ã": ["–∫–æ–Ω—Ç–∞–∫—Ç", "—Ç–µ–ª–µ—Ñ–æ–Ω", "–∞–¥—Ä–µ—Å", "—Å–≤—è–∑–∞—Ç—å—Å—è", "–ø–æ–∑–≤–æ–Ω–∏—Ç—å", "–Ω–∞–ø–∏—Å–∞—Ç—å"],
            "—Å—Ä–æ–∫–∏": ["—Å—Ä–æ–∫", "–∫–æ–≥–¥–∞", "–≤—Ä–µ–º—è", "–¥–æ–ª–≥–æ", "–±—ã—Å—Ç—Ä–æ", "–¥–µ–Ω—å", "–¥–Ω–µ–π"],
            "–æ–ø–ª–∞—Ç–∞": ["–æ–ø–ª–∞—Ç–∞", "–∫–∞—Ä—Ç–∞", "–Ω–∞–ª", "—Ä–∞—Å—Å—Ä–æ—á–∫–∞", "–∫—Ä–µ–¥–∏—Ç", "–ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞"],
            "—É–±–æ—Ä–∫–∞": ["—É–±–æ—Ä–∫–∞", "–º—É—Å–æ—Ä", "—á–∏—Å—Ç–æ", "–≥—Ä—è–∑–Ω–æ", "–ø—ã–ª—å"],
            "—Ü–≤–µ—Ç–∞": ["—Ü–≤–µ—Ç", "–±–µ–ª—ã–π", "—á–µ—Ä–Ω—ã–π", "–æ—Ç—Ç–µ–Ω–æ–∫", "–ø–∞–ª–∏—Ç—Ä–∞", "–≤—ã–±–æ—Ä —Ü–≤–µ—Ç–∞"],
            "—Å–≤–µ—Ç–∏–ª—å–Ω–∏–∫–∏": ["—Å–≤–µ—Ç", "–ª–∞–º–ø–∞", "–ª—é—Å—Ç—Ä–∞", "—Å–≤–µ—Ç–∏–ª—å–Ω–∏–∫", "–ø–æ–¥—Å–≤–µ—Ç–∫–∞", "–æ—Å–≤–µ—â–µ–Ω–∏–µ"]
        }

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
        for category, keywords in keyword_map.items():
            if any(keyword in question_lower for keyword in keywords):
                if category in self.templates:
                    template = random.choice(self.templates[category])
                    return self._format_template(template)

        return None

    def _get_strict_system_prompt(self) -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–≥–∏–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç"""
        return f"""–¢—ã - —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –∫–æ–º–ø–∞–Ω–∏–∏ "{self.company_info['name']}" –ø–æ –ø—Ä–æ–¥–∞–∂–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –Ω–∞—Ç—è–∂–Ω—ã—Ö –ø–æ—Ç–æ–ª–∫–æ–≤.

–ö–û–ú–ü–ê–ù–ò–Ø: {self.company_info['description']}
–£–°–õ–£–ì–ò: {', '.join(self.company_info['services'])}
–ú–ê–¢–ï–†–ò–ê–õ–´: {', '.join(self.company_info['materials'])}
–¶–ï–ù–´: {json.dumps(self.company_info['prices'], ensure_ascii=False)}
–ö–û–ù–¢–ê–ö–¢–´: {self.company_info['contact']['phone']}, {self.company_info['contact']['email']}

–°–¢–†–û–ì–ò–ï –ü–†–ê–í–ò–õ–ê:
1. –û–¢–í–ï–ß–ê–ô –¢–û–õ–¨–ö–û –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï
2. –ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–ª–æ–≤–∞
3. –û—Ç–≤–µ—á–∞–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–ª–µ–∑–Ω–æ –∏ –ø–æ –¥–µ–ª—É
4. –ë—É–¥—å –≤–µ–∂–ª–∏–≤—ã–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º
5. –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫—Ä–∞—Ç–∫–∏–º (1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
6. –ò—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–ø–∞–Ω–∏–∏ –≤—ã—à–µ
7. –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å –æ—Ç–≤–µ—Ç–∞ - —Å–∫–∞–∂–∏ "–£—Ç–æ—á–Ω—é —É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞"

–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:
- "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—Ç—è–∂–Ω–æ–≥–æ –ø–æ—Ç–æ–ª–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç 1 –¥–µ–Ω—å."
- "–°—Ç–æ–∏–º–æ—Å—Ç—å –º–∞—Ç–æ–≤–æ–≥–æ –ø–æ—Ç–æ–ª–∫–∞ –æ—Ç 450 —Ä—É–±–ª–µ–π –∑–∞ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–π –º–µ—Ç—Ä."
- "–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º –≥–∞—Ä–∞–Ω—Ç–∏—é 5 –ª–µ—Ç –Ω–∞ –≤—Å–µ —Ä–∞–±–æ—Ç—ã."

–ü—Ä–∏–º–µ—Ä—ã –ù–ï–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:
- "Installation takes 1 day." ‚ùå (–∞–Ω–≥–ª–∏–π—Å–∫–∏–π)
- "Price is 450 rub." ‚ùå (—Å–º–µ—à–∞–Ω–Ω—ã–π)
- "–°—Ç–æ–∏–º–æ—Å—Ç—å 450 rub per m2." ‚ùå (–∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–ª–æ–≤–∞)

–í–ê–ñ–ù–û: –¢–û–õ–¨–ö–û –ß–ò–°–¢–´–ô –†–£–°–°–ö–ò–ô –Ø–ó–´–ö!"""

    def _clean_russian_response(self, text: str) -> str:
        """–û—á–∏—â–∞–µ—Ç –æ—Ç–≤–µ—Ç, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ —Ä—É—Å—Å–∫–∏–π —Ç–µ–∫—Å—Ç"""
        if not text:
            return "–£—Ç–æ—á–Ω—é —É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –∏ –æ—Ç–≤–µ—á—É –ø–æ–∑–∂–µ."

        # –£–¥–∞–ª—è–µ–º –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–ª–æ–≤–∞ (–æ—Ç 2 –±—É–∫–≤)
        text = re.sub(r'\b[a-zA-Z]{2,}\b', '', text)

        # –£–¥–∞–ª—è–µ–º –æ–¥–∏–Ω–æ—á–Ω—ã–µ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –±—É–∫–≤—ã
        text = re.sub(r'\b[a-zA-Z]\b', '', text)

        # –£–¥–∞–ª—è–µ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã
        text = re.sub(r'[^\w\s–∞-—è–ê-–Ø—ë–Å.,!?;:-]', '', text)

        # –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
        text = re.sub(r'\s+', ' ', text).strip()

        # –ï—Å–ª–∏ –æ—Å—Ç–∞–ª—Å—è —Ç–æ–ª—å–∫–æ –ø—É–Ω–∫—Ç—É–∞—Ü–∏—è –∏–ª–∏ –º–∞–ª–æ —Ç–µ–∫—Å—Ç–∞
        if len(text) < 10 or not any('–∞' <= c <= '—è' or '–ê' <= c <= '–Ø' for c in text):
            return "–£—Ç–æ—á–Ω—é —É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –∏ –æ—Ç–≤–µ—á—É –ø–æ–∑–∂–µ."

        # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –æ—Ç–≤–µ—Ç –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è —Ç–æ—á–∫–æ–π
        if text and text[-1] not in '.!?':
            text += '.'

        return text

    def get_ai_response(self, question: str) -> str:
        """–ü–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò —Å —É—Å–∏–ª–µ–Ω–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π"""

        # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
        messages = [{'role': 'system', 'content': self._get_strict_system_prompt()}]

        # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –æ–±–º–µ–Ω–∞ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
        for msg in self.conversation_history[-4:]:
            messages.append(msg)

        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å
        messages.append({'role': 'user', 'content': question})

        try:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å –æ—á–µ–Ω—å –Ω–∏–∑–∫–æ–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–æ–π
            response = ollama.chat(
                model=self.model_name,
                messages=messages,
                options={
                    'temperature': 0.05,  # –û—á–µ–Ω—å –Ω–∏–∑–∫–∞—è –¥–ª—è —Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞–º
                    'num_predict': 200,
                    'top_k': 5,
                    'top_p': 0.9,
                    'repeat_penalty': 1.3,
                    'stop': ['\n\n', 'English:', '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π:', '–∞–Ω–≥–ª–∏–π—Å–∫–∏–π', 'English']
                }
            )

            # –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Ç–≤–µ—Ç
            if isinstance(response, dict):
                raw_answer = response.get('message', {}).get('content', '')
            else:
                raw_answer = str(response)

            # –û—á–∏—â–∞–µ–º –æ—Ç–≤–µ—Ç
            cleaned_answer = self._clean_russian_response(raw_answer)

            # –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ—Ç–æ–ª–∫–∞—Ö, –¥–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π
            if not any(
                    word in cleaned_answer.lower() for word in ['–ø–æ—Ç–æ–ª', '—É—Å—Ç–∞–Ω', '–º–∞—Ç–µ—Ä', '—Ü–µ–Ω', '–≥–∞—Ä–∞–Ω—Ç', '–∑–∞–º–µ—Ä']):
                cleaned_answer = "–ü—Ä–µ–¥–ª–∞–≥–∞—é –ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ —ç—Ç–æ–º—É –≤–æ–ø—Ä–æ—Å—É —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º."

            return cleaned_answer

        except Exception as e:
            return "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –≤–æ–ø—Ä–æ—Å."

    def ask(self, question: str) -> str:
        """–û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞"""

        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º —à–∞–±–ª–æ–Ω—ã
        template_response = self._find_template_response(question)
        if template_response:
            response = template_response
            source = "—à–∞–±–ª–æ–Ω"
        else:
            # –ï—Å–ª–∏ –Ω–µ—Ç —à–∞–±–ª–æ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ò–ò
            response = self.get_ai_response(question)
            source = "–ò–ò"

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
        self.conversation_history.append({'role': 'user', 'content': question})
        self.conversation_history.append({'role': 'assistant', 'content': response})

        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
        if len(self.conversation_history) > 8:
            self.conversation_history = self.conversation_history[-8:]

        # –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        debug_info = f"\n[–ò—Å—Ç–æ—á–Ω–∏–∫: {source}, –ò—Å—Ç–æ—Ä–∏—è: {len(self.conversation_history) // 2} —Å–æ–æ–±—â–µ–Ω–∏–π]"

        return response + (debug_info if self.debug_mode else "")

    def interactive_chat(self, debug_mode: bool = False):
        """–ó–∞–ø—É—Å–∫–∞–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç"""
        self.debug_mode = debug_mode

        print(f"üè¢ {self.company_info['name']} - –ß–∞—Ç-–ø–æ–º–æ—â–Ω–∏–∫")
        print("=" * 60)
        print(f"üìù {self.company_info['description']}")
        print("üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã:", self.company_info["contact"]["phone"])
        print("=" * 60)
        print("üí¨ –ó–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –æ –Ω–∞—Ç—è–∂–Ω—ã—Ö –ø–æ—Ç–æ–ª–∫–∞—Ö")
        print("üìã –ö–æ–º–∞–Ω–¥—ã: /info, /—Ü–µ–Ω—ã, /—É—Å–ª—É–≥–∏, /–∫–æ–Ω—Ç–∞–∫—Ç—ã, /—Å–±—Ä–æ—Å, /–≤—ã—Ö–æ–¥")
        print("=" * 60)

        while True:
            try:
                question = input("\nüë§ –í–∞—à –≤–æ–ø—Ä–æ—Å: ").strip()

                if not question:
                    continue

                # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥
                if question.startswith('/'):
                    if question == '/–≤—ã—Ö–æ–¥':
                        print("üëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è! –ñ–¥–µ–º –≤–∞—Å –≤ {self.company_info['name']}!")
                        break
                    elif question == '/info':
                        print(f"\nüìã –û –∫–æ–º–ø–∞–Ω–∏–∏:")
                        print(f"   {self.company_info['description']}")
                        print(f"   –£—Å–ª—É–≥–∏: {', '.join(self.company_info['services'][:3])}...")
                        print(f"   –¢–µ–ª–µ—Ñ–æ–Ω: {self.company_info['contact']['phone']}")
                        continue
                    elif question == '/—Ü–µ–Ω—ã':
                        print("\nüí∞ –¶–µ–Ω—ã –Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:")
                        for material, price in self.company_info['prices'].items():
                            print(f"   {material}: {price}")
                        continue
                    elif question == '/—É—Å–ª—É–≥–∏':
                        print("\nüîß –ù–∞—à–∏ —É—Å–ª—É–≥–∏:")
                        for service in self.company_info['services']:
                            print(f"   ‚Ä¢ {service}")
                        continue
                    elif question == '/–∫–æ–Ω—Ç–∞–∫—Ç—ã':
                        print("\nüìû –ö–æ–Ω—Ç–∞–∫—Ç—ã:")
                        for key, value in self.company_info['contact'].items():
                            print(f"   {key}: {value}")
                        continue
                    elif question == '/—Å–±—Ä–æ—Å':
                        self.conversation_history = []
                        print("‚úÖ –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –æ—á–∏—â–µ–Ω–∞")
                        continue
                    elif question == '/–ø–æ–º–æ—â—å':
                        print("\nüìñ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:")
                        print("   /info     - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–ø–∞–Ω–∏–∏")
                        print("   /—Ü–µ–Ω—ã     - —Ü–µ–Ω—ã –Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª—ã")
                        print("   /—É—Å–ª—É–≥–∏   - —Å–ø–∏—Å–æ–∫ —É—Å–ª—É–≥")
                        print("   /–∫–æ–Ω—Ç–∞–∫—Ç—ã - –∫–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è")
                        print("   /—Å–±—Ä–æ—Å    - –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞")
                        print("   /–≤—ã—Ö–æ–¥    - –∑–∞–≤–µ—Ä—à–∏—Ç—å —á–∞—Ç")
                        continue
                    else:
                        print("‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –í–≤–µ–¥–∏—Ç–µ /–ø–æ–º–æ—â—å –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥.")
                        continue

                # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
                print("ü§ñ –î—É–º–∞—é...")
                answer = self.ask(question)

                # –í—ã–≤–æ–¥–∏–º –æ—Ç–≤–µ—Ç —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
                print(f"\nü§ñ {self.company_info['name']}:")
                print(f"   {answer}")

            except KeyboardInterrupt:
                print("\n\nüëã –ü—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
                break
            except Exception as e:
                print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
                print("–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å —Å–Ω–æ–≤–∞.")


def test_bot():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–æ—Ç–∞"""
    bot = PotolkiBot()

    test_questions = [
        "–ü—Ä–∏–≤–µ—Ç",
        "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –Ω–∞—Ç—è–∂–Ω–æ–π –ø–æ—Ç–æ–ª–æ–∫?",
        "–ö–∞–∫–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ?",
        "–ó–∞ —Å–∫–æ–ª—å–∫–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–æ—Ç–æ–ª–æ–∫ –≤ –∫–æ–º–Ω–∞—Ç–µ 20 –∫–≤.–º?",
        "–ï—Å—Ç—å –ª–∏ –≥–∞—Ä–∞–Ω—Ç–∏—è?",
        "–ö–∞–∫ –±—ã—Å—Ç—Ä–æ –ø—Ä–∏–µ–¥–µ—Ç –∑–∞–º–µ—Ä—â–∏–∫?",
        "–†–∞–±–æ—Ç–∞–µ—Ç–µ –ª–∏ –≤ –≤—ã—Ö–æ–¥–Ω—ã–µ?",
        "–£–±–∏—Ä–∞–µ—Ç–µ—Å—å –ª–∏ –ø–æ—Å–ª–µ –º–æ–Ω—Ç–∞–∂–∞?",
        "–ö–∞–∫–∏–µ —Ü–≤–µ—Ç–∞ –µ—Å—Ç—å –≤ –Ω–∞–ª–∏—á–∏–∏?",
        "–ú–æ–∂–Ω–æ –ª–∏ —Å –ø–æ—Ç–æ–ª–∫–æ–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–≤–µ—Ç–∏–ª—å–Ω–∏–∫–∏?",
        "What is your price?",  # –ù–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º - –ø—Ä–æ–≤–µ—Ä–∏–º
        "Hello, how are you?",  # –ï—â–µ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π
        "–ö–æ–≥–¥–∞ –º–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Ç–æ–ª–æ–∫?",
        "–ï—Å—Ç—å –ª–∏ —Ä–∞—Å—Å—Ä–æ—á–∫–∞?",
        "–ö–∞–∫–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏?"
    ]

    print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–æ—Ç–∞ –¥–ª—è –Ω–∞—Ç—è–∂–Ω—ã—Ö –ø–æ—Ç–æ–ª–∫–æ–≤")
    print("=" * 60)

    for i, question in enumerate(test_questions, 1):
        print(f"\n{i}. üë§ –í–æ–ø—Ä–æ—Å: {question}")
        answer = bot.ask(question)
        print(f"   ü§ñ –û—Ç–≤–µ—Ç: {answer}")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π
        english_chars = sum(1 for c in answer if 'a' <= c <= 'z' or 'A' <= c <= 'Z')
        if english_chars > 0:
            print(f"   ‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤: {english_chars}")

    print("\n" + "=" * 60)
    print("‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!")
    print(f"üìä –í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤: {len(test_questions)}")


if __name__ == "__main__":
    import sys

    if len(sys.argv) > 1 and sys.argv[1] == '--test':
        test_bot()
    else:
        bot = PotolkiBot()
        bot.interactive_chat(debug_mode=False)